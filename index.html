<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Open Tal on WhatsApp</title>
    <meta name="description" content="Start chatting with Tal on WhatsApp">
    <meta name="theme-color" content="#ff6b35">

    <!-- Open Graph -->
    <meta property="og:title" content="Chat with Tal">
    <meta property="og:description" content="Your personal career agent on WhatsApp">
    <meta property="og:type" content="website">

    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="card">
        <!-- Tal's Logo -->
        <div class="logo">
            <img src="Tal 2.png" alt="Tal logo">
        </div>

        <h1>LinkedIn is worse on Android.</h1>

        <div class="company-pill" id="companyPill"></div>

        <p class="instruction">You'll have to do this twice. When this pops up, tap <strong>Retry</strong>.</p>

        <!-- Screenshot with animated overlays - wrapped in link -->
        <a href="#" id="screenshotLink">
            <div class="screenshot-container">
                <img src="Screenshot.jpeg" alt="Tap Retry when you see this popup" class="screenshot-img">

                <!-- Scan line animation -->
                <div class="scan-line"></div>

                <!-- Pulsing highlight around Retry button area -->
                <div class="retry-highlight"></div>

                <!-- Animated cursor/hand -->
                <div class="tap-cursor">
                    <svg viewBox="0 0 24 24" fill="currentColor" width="32" height="32">
                        <path d="M13.75 2.5a1.25 1.25 0 0 0-2.5 0v8.25H9.75a1.25 1.25 0 0 0 0 2.5h1.5v1h-1.5a1.25 1.25 0 0 0 0 2.5h1.5v2.5a1.25 1.25 0 0 0 2.5 0v-2.5h1.5a1.25 1.25 0 0 0 0-2.5h-1.5v-1h1.5a1.25 1.25 0 0 0 0-2.5h-1.5V2.5z"/>
                    </svg>
                </div>
            </div>
        </a>

        <a
            href="#"
            class="btn-primary"
            id="whatsappBtn"
            aria-label="Open WhatsApp to chat with Tal"
        >
            Open WhatsApp
        </a>
    </div>

    <script>
        // Configuration
        const WHATSAPP_NUMBER = '919224262682';
        const WHATSAPP_MESSAGE = 'Hi Tal, count me in!';
        const INTENT_TIMEOUT = 1500; // ms to wait before falling back

        // Build WhatsApp URLs
        const whatsappUrl = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(WHATSAPP_MESSAGE)}`;
        const whatsappDeepLink = `whatsapp://send?phone=${WHATSAPP_NUMBER}&text=${encodeURIComponent(WHATSAPP_MESSAGE)}`;
        const whatsappIntent = `intent://send?phone=${WHATSAPP_NUMBER}&text=${encodeURIComponent(WHATSAPP_MESSAGE)}#Intent;scheme=whatsapp;package=com.whatsapp;S.browser_fallback_url=${encodeURIComponent(whatsappUrl)};end`;

        // Detect LinkedIn in-app browser
        function isLinkedInBrowser() {
            const ua = navigator.userAgent || navigator.vendor || window.opera;
            return ua.includes('LinkedIn') || ua.includes('LinkedInApp');
        }

        // Detect Android
        function isAndroid() {
            return /android/i.test(navigator.userAgent);
        }

        // Track if intent succeeded
        let intentSucceeded = false;
        let fallbackTimer = null;

        // Listen for visibility change (app switch = intent worked)
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'hidden') {
                intentSucceeded = true;
                if (fallbackTimer) {
                    clearTimeout(fallbackTimer);
                    fallbackTimer = null;
                }
                console.log('Page hidden - intent likely succeeded');
            }
        });

        // Async intent loader with fallback
        function openWhatsAppAsync(e) {
            e.preventDefault();

            const isAndroidDevice = isAndroid();

            if (isAndroidDevice) {
                console.log('Trying intent URL first...');
                intentSucceeded = false;

                // Create hidden iframe to try intent without navigating away
                const iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                iframe.src = whatsappIntent;
                document.body.appendChild(iframe);

                // Also try direct navigation
                window.location.href = whatsappIntent;

                // Set fallback timer
                fallbackTimer = setTimeout(function() {
                    if (!intentSucceeded && document.visibilityState === 'visible') {
                        console.log('Intent timeout - falling back to wa.me');
                        window.location.href = whatsappUrl;
                    }
                    // Clean up iframe
                    if (iframe.parentNode) {
                        iframe.parentNode.removeChild(iframe);
                    }
                }, INTENT_TIMEOUT);

            } else {
                // iOS/Desktop: Use standard wa.me URL directly
                console.log('Non-Android - using wa.me directly');
                window.location.href = whatsappUrl;
            }
        }

        // Set up click handlers on page load
        window.addEventListener('load', function() {
            const isLinkedIn = isLinkedInBrowser();
            const isAndroidDevice = isAndroid();
            const whatsappBtn = document.getElementById('whatsappBtn');
            const screenshotLink = document.getElementById('screenshotLink');

            // Use click handlers for async logic
            whatsappBtn.addEventListener('click', openWhatsAppAsync);
            screenshotLink.addEventListener('click', openWhatsAppAsync);

            // Set href as fallback for middle-click/right-click
            var fallbackUrl = isAndroidDevice ? whatsappIntent : whatsappUrl;
            whatsappBtn.href = fallbackUrl;
            screenshotLink.href = fallbackUrl;

            console.log('Page loaded. User Agent:', navigator.userAgent);
            console.log('LinkedIn Browser:', isLinkedIn);
            console.log('Android:', isAndroidDevice);
        });
    </script>
</body>
</html>
